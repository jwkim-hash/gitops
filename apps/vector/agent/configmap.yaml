apiVersion: v1
kind: ConfigMap
metadata:
  name: vector-agent-config
  namespace: vector
data:
  vector.yaml: |
    data_dir: /vector-data-dir

    sources:
      kubernetes_logs:
        type: kubernetes_logs
        extra_label_selector: "vector.dev/exclude!=true"

      edge_logs:
        type: file
        include:
          - /tmp/access.log
        read_from: beginning
        fingerprint:
          strategy: device_and_inode

    transforms:
      parse_logs:
        type: remap
        inputs:
          - kubernetes_logs
        source: |
          .timestamp = now()
          .node = get_env_var!("NODE_NAME")

      parse_edge_logs:
        type: remap
        inputs:
          - edge_logs
        source: |
          # Parse NDJSON (newline-delimited JSON)
          . = parse_json!(.message)

          # Add collection metadata
          .collected_at = now()
          .collector_node = get_env_var!("NODE_NAME")
          .log_source = "edge_cdn"

    sinks:
      aggregator:
        type: vector
        inputs:
          - parse_logs
        address: vector-aggregator.vector.svc.cluster.local:9000
        compression: true

      edge_aggregator:
        type: vector
        inputs:
          - parse_edge_logs
        address: vector-aggregator.vector.svc.cluster.local:9000
        compression: true

      edge_console:
        type: console
        inputs:
          - parse_edge_logs
        encoding:
          codec: json
        target: stdout
